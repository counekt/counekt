{% extends "base.html" %}
{% block content %}
<div id="profile">
  <div id="profile-top" class="floater container">
    <div id="profile-left">
      <div id="profile-image">
        <a href="/club/{{club.handle}}/photo/">
        <img alt draggable="false" id="profile-image-content" src="{{ club.profile_photo.src }}">
        </a>
      </div>
      <div id="profile-left-bottom">
        <p class="title is-4 selectable" style="color:black"><b>{{ club.name }}</b></p>
        <p class="subtitle is-5 selectable" style="color:gray">€{{ club.handle }}</p>
      </div>
    </div>

    <div id="profile-right">
      <div id="profile-right-top">
        <div id="profile-bar" class="field">
          <div id="profile-bar-content">
            {% if club not in current_user.clubs %}
              <button class="button is-info is-inverted" id="more-details-button"><span class="icon is-small"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></span></button>
              {% with request_sent = models.UserToClubRequest.query.filter_by(type='join', sender=current_user, receiver=club).first(), request_received = models.ClubToUserRequest.query.filter_by(type='invite', sender=club, receiver=current_user).first(), is_joined = club in current_user.clubs %}
              <button id="join-button" class="button {% if is_joined %}is-info{% elif request_sent %} is-light {% elif request_received  %}is-success{% else %}is-link{% endif %}" data-type="{% if is_joined %}joined{% elif request_sent %}pending{% elif request_received %}accept{% else %}default{% endif %}">
                {% if is_joined %}
                  {% include 'profiles/join-button/joined.html' %}
                {% elif request_sent %}
                  {% include 'profiles/join-button/pending.html' %}
                {% elif request_received %}
                  {% include 'profiles/join-button/accept.html' %}
                {% else %}
                  {% include 'profiles/join-button/default.html' %}
                {% endif %}
              </button>
              {% endwith %}
              <!--<button class="button is-info is-inverted" id="join-button">Join</button>-->
            {% else %}
              <button class="button is-info is-inverted" id="edit-button" href="/settings/profile/">Edit Club</button>
            {% endif %}
          </div>
          <br style="clear: both;">
        </div>
        <div id="profile-bio" class="selectable">
        <p style="color:black"> {% if club.description %}{{club.description}}{% endif %} </p>
        </div>
      </div>
      <div id="profile-right-bottom">
        {% if club.address %}
        <div id="profile-address">
          <span class="icon is-small"><i class="fa fa-map-marker" aria-hidden="true"></i></span><span class="selectable">{{club.address}}</span>
        </div>
        {% endif %}
      </div>
    </div>
    <br style="clear: both;">
  </div>
  <!-- 
  {% raw %}
  {% if club.skills.all() %}
  <div id="profile-skills" class="container">
    {% for skillrow in skillrows %}
    <div class="profile-skill-row">
    {% for skill in skillrow %}
      <div class="profile-skill" style="color: {{skill_aspects[skill.title]['color']}}; background-color: {{skill_aspects[skill.title]['background-color']}};"><span>{{skill.title}}</span></div>
    {% endfor %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endraw  %}
  -->
  <div id="profile-tabs" class="container">
    <div class="tabs is-centered is-fullwidth is-toggle is-large" style="color: black;">
<<<<<<< HEAD
    <ul>
      <li class="is-active" data-content="#profile-members">
        <a>
          <span class="icon is-small"><i class="fas fa-group" aria-hidden="true"></i></span>
          <span class="tabtext">Members</span>
        </a>
      </li>
      <li data-content="#profile-roles">
        <a>
          <span class="icon is-small"><i class="fab fa-black-tie" aria-hidden="true"></i></span>
          <span class="tabtext">Roles</span>
        </a>
      </li>
      <li data-content="#profile-comms">
        <a>
          <span class="icon is-small"><i class="fas fa-wifi" aria-hidden="true"></i></span>
          <span class="tabtext">Comms</span>
        </a>
      </li>
    </ul>
    </div>
    {%if current_user in club.group.members %}
    <div id="profile-tabs-content">
        <div id="profile-allies" class="profile-associate">
          {% for member in club.group.members %}
          <div class="subprofile box">
            <div class="subprofile-image-wrap">
            <a class="subprofile-image" href="{{url_for('profiles.user',username=member.username) | replace('%40', '@')}}">
                <img alt draggable="false" class="subprofile-image-content" src="{{member.profile_photo.src}}">
            </a>
          </div>
            <div class="subprofile-content">
              <a class="subprofile-identity" href="{{url_for('profiles.user',username=member.username) | replace('%40', '@')}}">
                <span class="subprofile-name selectable"><b>{% if member.name %}{{member.name}}{% else %}{{member.username}}{% endif %}</b></span>
                <br>
                <span class="subprofile-username selectable">@{{member.username}}</span>
              </a>
              <br>
            <span class="subprofile-bio selectable" maxlenght="30">{% if member.bio %}{{member.bio}}{% endif %}</span>
          </div>
          </div>
          {% endfor %}
          {% if current_user in club.group.members %} <!--and club.group.member_has_role(member=current_user, role_title="Master")-->
          <a id="members-button"><div class="add-specific-button"><span>Add member</span></div></a>
          {% endif %}
        </div>
        <div id="profile-roles" class="profile-associate vanish">
          
          <!--{% for role in club.roles %}
          {% endfor %}-->
          {% if current_user in club.group.members %}
          <a id="roles-button"><div class="add-specific-button" id="create-club-button"><span>Add role</span></div></a>
          {% endif %}
        </div>
        <div id="profile-projects" class="profile-associate vanish">
          {% if current_user in club.group.members %}
          <div class="add-specific-button" id="create-project-button"><span>Add comm</span></div>
          {% endif %}
        </div>
    </div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block modal %}
{% if request.url_rule.endpoint == 'profiles.edit_club' %}
{% include "profiles/club/edit.html" %}
{% elif request.url_rule.endpoint == 'profiles.club_photo' %}
{% with photo_src=club.profile_photo.src %}
{% include "profiles/photo.html" %}
{% endwith %}
{% elif request.url_rule.endpoint == 'profiles.club_add_members' %}
{% include "profiles/add-members.html" %}
{% elif request.url_rule.endpoint == 'profiles.club_add_roles' %}
{% include "profiles/add-roles.html" %}
{% endif %}

{% endblock %}

{% block scripts %}
<!-- Probably good for now to have this below-->

<link rel="stylesheet" href="/static/css/profiles/profile.css">
<link rel="stylesheet" href="/static/css/profiles/mini-profile.css">
<link rel="stylesheet" href="/static/css/profiles/edit.css">
<link rel="stylesheet" href="/static/css/profiles/photo.css">
<link rel="stylesheet" href="/static/css/profiles/add-members.css">
<link rel="stylesheet" href="/static/css/profiles/add-roles.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<!-- Probably good for now to have this below-->
<script src="/static/js/profiles/user/profile.js"></script>
<script src="/static/js/profiles/club/profile.js"></script>
<script src="/static/js/profiles/club/edit.js"></script>
<script src="/static/js/profiles/configure-skills.js"></script>
<script src="/static/js/feedback.js"></script>
<script src="/static/js/load-image.js"></script>
<script src="/static/js/datepicker.js"></script>
<script src="/static/js/profiles/add-members.js"></script>
<script src="/static/js/profiles/add-roles.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script type="text/javascript">


  var handle = "{{club.handle}}";

  function makeConnectButtonDefault() {
    $('#join-button').addClass('is-info');
    $('#join-button').removeClass('is-light').removeClass('is-link');
    $('#join-button').html(`{% include 'profiles/join-button/default.html' %}`);
    $('#join-button').data('type', 'default');
    $('#join-button').removeClass('is-danger');
    
  }

  function makeConnectButtonPending() {
    $('#join-button').toggleClass('is-info is-light');
    $('#join-button').html(`{% include 'profiles/join-button/pending.html' %}`);
    $('#join-button').data('type', 'pending');
    $('#join-button').addClass('calm');
  }

  function makeConnectButtonConnected() {
    $('#join-button').toggleClass('is-success is-info');
    $('#join-button').html(`{% include 'profiles/join-button/joined.html' %}`);
    $('#join-button').data('type', 'joined');
    $('#join-button').addClass('calm');
  }

$("#join-button").hover(
  function() {
        if ($(this).data('type') == 'joined' && !$(this).hasClass('calm')) {
          $(this).addClass('is-danger');
          $(this).html(`{% include 'profiles/join-button/leave.html' %}`);
        }
        else if ($(this).data('type') == 'pending' && !$(this).hasClass('calm')) {
          $(this).addClass('is-danger');
          $(this).html(`{% include 'profiles/join-button/undo.html' %}`);

    }
  }, function() {
        if ($(this).data('type') == 'joined') {
          $(this).removeClass('is-danger');
          $(this).html(`{% include 'profiles/join-button/joined.html' %}`);
          $(this).removeClass('calm');

        }
        else if ($(this).data('type') == 'pending') {
          $(this).removeClass('is-danger');
          $(this).removeClass('calm');
          $(this).html(`{% include 'profiles/join-button/pending.html' %}`);

        }
  }
);
 

</script>
<script type="text/javascript">
  var handle = "{{club.handle}}";

  function load_map_js() {
  var map = L.map('map').setView({% if club.latitude and club.longitude %}[{{club.latitude}}, {{club.longitude}}], 12{% else %}[55.676111, 12.568333], 2{% endif %});
         
         //CartoDB layer names: light_all / dark_all / light_nonames / dark_nonames
         layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 13,
            minZoom: 2
         }).addTo(map);
         // Create additional Control placeholders
var markerGroup = L.layerGroup().addTo(map);

map.on('click', function(e){
    placeMarker(e.latlng);
    getAddress(e.latlng);
});

var marker;

{% if club.latitude and club.longitude %}
  marker = new L.marker([{{club.latitude}}, {{club.longitude}}]).addTo(markerGroup);
{% endif %}

window.getLatLng = function() {
  return(marker.getLatLng());
}

window.markerIsPlaced = function() {
  if (marker) {
    return(true);
  }
  return(false);
}

function placeMarker(latlng, zoom_all_in=false) {
  markerGroup.clearLayers();
    marker = new L.marker(latlng).addTo(markerGroup);
    if (zoom_all_in) {
      map.flyTo(latlng, 13);
    }
    else {
    map.flyTo(latlng, map.getZoom());
    }
    //map.flyTo(latlng, Math.min(13,map.getZoom()+1));
    //map.flyTo(latlng, 13);
    //if(map.getZoom()===2){map.flyTo(e.latlng, 13);}else{map.flyTo(e.latlng, map.getZoom());}
    console.log(latlng);
}

  function addControlPlaceholders(map) {
    var corners = map._controlCorners,
        l = 'leaflet-',
        container = map._controlContainer;

    function createCorner(vSide, hSide) {
        var className = l + vSide + ' ' + l + hSide;

        corners[vSide + hSide] = L.DomUtil.create('div', className, container);
    }

    createCorner('verticalcenter', 'left');
    createCorner('verticalcenter', 'right');
}

addControlPlaceholders(map);

// Change the position of the Zoom Control to a newly created placeholder.
map.zoomControl.setPosition('bottomright');

// You can also put other controls in the same placeholder.

var proIcon = L.icon({
    iconUrl: 'static/images/pro-pic.png',

    iconSize:     [25, 25], // size of the icon
    iconAnchor:   [12.5, 12.5], // point of the icon which will correspond to marker's location
    popupAnchor:  [-2, 0] // point from which the popup should open relative to the iconAnchor
});

function getAddress(latlng) {
  console.log(latlng);
  var formData = new FormData();
  formData.append('lat', latlng.lat);
  formData.append('lng', latlng.lng);
  $.post({
      type: "POST",
      url: "/get/address/",
      data: formData,
      processData: false,
      contentType: false,
      success(response) {
        var response = JSON.parse(response);
        var status = response["status"];
        if (status === "success") {stopErrorAlert("location-field");
  stopErrorAlert("map");$("#location-field").val(response["address"])}
        else{console.log("WUUUT"); $("#location-field").val(""); alertError("map");}
        
      }});
}

function getCoordinates() {
  var formData = new FormData();
  formData.append('address', $("#location-field").val());
  $.post({
      type: "POST",
      url: "/get/coordinates/",
      data: formData,
      processData: false,
      contentType: false,
      success(response) {
        var response = JSON.parse(response);
        var status = response["status"];
        if (status === "success") {stopErrorAlert("location-field");
  stopErrorAlert("map");placeMarker([response["lat"],response["lng"]]);}
        else{console.log("WWW");alertError("location-field");}
      }});
}

$(document).on('focusout', '#location-field', function() {
  console.log("coord");
  getCoordinates();
});

$('#location-field').keypress(function(event){
  if(event.keyCode == 13){
    console.log("coord");
    getCoordinates();
  }
});

$('#show-location').change(function() {
        if($(this).is(":checked")) {
            console.log("checked");
          $('#location-settings').removeClass("vanish");
        }
        else {
           console.log("unchecked");
          $('#location-settings').addClass("vanish");
        }
       });

if(!$('#show-location').is(":checked")) {
  $('#location-settings').addClass("vanish");
  }

}

{% if request.url_rule.endpoint in ['profiles.edit_club']  %}
load_map_js();
{% endif %}
</script>
<script type="text/javascript">
  function sendInvites() {
    sendClubInvites();
  }

function sendClubInvites() {
  var formData = new FormData();
    var usernames = JSON.stringify($("#add-members-tags-container").children().toArray().map( element => $(element).data('username')));
    console.log(usernames);
    formData.append("usernames", usernames);
    formData.append("do", true)

    $.post({
      type: "POST",
      url: "/€"+handle+"/invite/",
      data: formData,
      processData: false,
      contentType: false,
      success(response) {
        var response = JSON.parse(response);
        var status = response["status"];
        if (status === "success") { location.replace("/€"+response["handle"]+"/"); }
        else{message(status, response["box_id"], true);}
        
      }});
}

{% if request.url_rule.endpoint in ['profiles.club_add_members']  %}
load_add_members_js();
{% endif %}
</script>
<script type="text/javascript">

  $(document).on('click', '#profile-image a', function(e) {
    redirect({id:"club-photo"},"Profile photo", "/€{{club.handle}}/photo/", changeToPhoto);
      e.preventDefault();
  });


  $(document).on('click', '#edit-button', function(e) {
    redirect({id:"edit-club"},"Edit club", "/€"+handle+"/edit/", changeToEdit);
    e.preventDefault();
  });

  $(document).on('click', '#members-button', function(e) {
    redirect({id:"club-members"},"Club members", "/€"+handle+"/members/", changeToMembers);
    e.preventDefault();
  });

  $(document).on('click', '#roles-button', function(e) {
    redirect({id:"club-roles"},"Club Roles Permission", "/€"+handle+"/roles/", changeRoles);
    e.preventDefault();
  });

$(document).on('click', '.close', function() {
  redirect({id:"club-profile"}, "Profile", "/€{{club.handle}}/", changeToProfile);
});

$(document).on('click', '.modal-background', function() {
    redirect({id:"club-profile"}, "Profile", "/€{{club.handle}}/", changeToProfile);
});

$(window).on("popstate", function() {
  if (window.history.state.id == "edit-club") {
    changeToEdit()
  }
  else if (window.history.state.id == "club-profile") {
    changeToProfile();
  }

  else if (window.history.state.id == "club-photo") {
    changeToPhoto();
  }

  else if (window.history.state.id == "club-members") {
    changeToMembers();
  }

  else if (window.history.state.id == "club-roles") {
    changeRoles();
  }


});

function changeToEdit() {
  $("#modal-box").append(`
    {% include "profiles/club/edit.html" %}`);
  load_map_js();
  $(document.body).addClass('noscroll');
}

function changeToProfile() {
  $("#modal-box").empty();
  $(document.body).removeClass('noscroll');
}

function changeToPhoto() {
  $("#modal-box").append(`
    {% with photo_src=club.profile_photo.src %}
    {% include "photo.html" %}
    {% endwith %}
    `);
  $(document.body).addClass('noscroll');
}

function changeToMembers() {
  $("#modal-box").append(`
    {% include "profiles/add-members.html" %}`);
  load_add_members_js()
  $(document.body).addClass('noscroll');
}

function changeRoles() {
  $("#modal-box").append(`
    {% include "profiles/add-roles.html" %}`);
  load_add_roles_js()
  $(document.body).addClass('noscroll');
}

{% if request.url_rule.endpoint == 'profiles.edit_club' %}
window.history.replaceState({id:"edit-club"},"Edit club", "/€{{club.handle}}/edit/");
{% elif request.url_rule.endpoint == 'profiles.club_photo' %}
window.history.replaceState({id:"club-photo"},"Profile photo", "/€{{club.handle}}/");
{% elif request.url_rule.endpoint == 'profiles.club_members' %}
window.history.replaceState({id:"club-add-members"},"Club add members", "/€{{club.handle}}/add-members/");
{% elif request.url_rule.endpoint == 'profiles.club_roles' %}
window.history.replaceState({id:"club-add-roles"},"Club add roles", "/€{{club.handle}}/add-roles/");
{% else %}
window.history.replaceState({id:"club-profile"},"Profile", "./");
{% endif %}
</script>
{% endblock %}